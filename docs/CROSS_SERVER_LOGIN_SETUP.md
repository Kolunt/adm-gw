# Настройка кросс-серверного логина

## Описание

Кросс-серверный логин позволяет пользователям авторизоваться в системе через их аккаунт в GWars.io. GWars.io проверяет подписи и перенаправляет пользователя обратно на наш сайт с параметрами авторизации.

## Проблема с localhost

GWars.io требует, чтобы URL редиректа (`url` параметр) соответствовал зарегистрированному домену (`gwadm.pythonanywhere.com`). При локальной разработке на `localhost` это вызывает ошибку "один сайт запрашивает подпись другого".

## Важно: Развертывание фронтенда на production

Перед использованием кросс-серверного логина убедитесь, что:

1. **Фронтенд собран и загружен на PythonAnywhere:**
   ```bash
   npm run build
   ```
   Затем загрузите папку `build` на сервер (через Files или Git)

2. **Структура файлов на сервере:**
   ```
   ~/gwadm/
   ├── backend/
   │   ├── main.py
   │   └── ...
   └── build/          # ← Обязательно должна быть!
       ├── index.html
       ├── static/
       └── ...
   ```

3. **Перезапустите веб-приложение** через раздел Web → Reload

4. **Проверьте, что SPA роутинг работает:**
   - Откройте `https://gwadm.pythonanywhere.com/my_login_page`
   - Должна загрузиться страница кросс-серверного логина (не 404!)

## Решения

### Вариант 1: Использование production URL (Рекомендуется)

Система автоматически использует production URL (`https://gwadm.pythonanywhere.com`) для редиректа при локальной разработке. Это означает, что после авторизации на GWars вы будете перенаправлены на production сайт, а не на localhost.

**Преимущества:**
- Не требует дополнительной настройки
- Работает из коробки
- Проще для тестирования

**Недостатки:**
- После авторизации вы попадете на production сайт
- Нужно вернуться на localhost вручную

### Вариант 2: Настройка через переменную окружения

Создайте файл `.env` в корне проекта (на основе `.env.example`):

```env
REACT_APP_CROSS_SERVER_REDIRECT_URL=https://gwadm.pythonanywhere.com
```

Это позволит переопределить URL редиректа при необходимости.

### Вариант 3: Использование hosts файла (Продвинутый)

Можно настроить локальную разработку так, чтобы `gwadm.pythonanywhere.com` указывал на `127.0.0.1`:

**Windows:**
1. Откройте файл `C:\Windows\System32\drivers\etc\hosts` с правами администратора
2. Добавьте строку:
   ```
   127.0.0.1    gwadm.pythonanywhere.com
   ```
3. Сохраните файл
4. Теперь в браузере используйте `http://gwadm.pythonanywhere.com:3000` вместо `localhost:3000`

**Linux/Mac:**
1. Откройте файл `/etc/hosts` с правами суперпользователя:
   ```bash
   sudo nano /etc/hosts
   ```
2. Добавьте строку:
   ```
   127.0.0.1    gwadm.pythonanywhere.com
   ```
3. Сохраните файл
4. Используйте `http://gwadm.pythonanywhere.com:3000` в браузере

**Важно:** После настройки hosts файла нужно обновить `getReturnUrl()` чтобы использовать `gwadm.pythonanywhere.com` вместо проверки localhost.

## Настройка на GWars.io

На GWars.io должна быть настроена кросс-серверная авторизация:

```
Пароль для подписи: deadmoroz
Домен: gwadm.pythonanywhere.com
URL для редиректа: https://gwadm.pythonanywhere.com/my_login_page
Site ID: 4
```

## Тестирование

1. Откройте страницу `/cross-server-login` или `/my_login_page`
2. Нажмите кнопку "Авторизация через GWars"
3. Вы будете перенаправлены на GWars.io
4. После авторизации GWars перенаправит вас обратно с параметрами
5. Система автоматически обработает параметры и авторизует вас

## Отладка

На странице кросс-серверного логина отображается отладочная информация со всеми параметрами, полученными от GWars.io. Это помогает диагностировать проблемы с подписями и параметрами.

## Заметки

- Подпись `sign4` содержит текущую дату, поэтому старая ссылка не будет работать на следующий день
- Все подписи проверяются на backend перед авторизацией пользователя
- Если пользователь не существует в системе, он будет автоматически создан

